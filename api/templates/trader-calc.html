{% extends 'base.html' %}
{% block title %}Trade helper{% endblock %}
{% block title_page %}Trade helper{% endblock %}
{% block content %}
<div class="container">
   <div class="form-row">
      <div class="form-group col-md-4">
         <label for="deposit">Депозит ($):</label>
         <input type="number" class="form-control" id="deposit" value="1000">
      </div>
      <div class="form-group col-md-4">
         <label for="positionPercentage">Відсоток позиції (%):</label>
         <input type="number" class="form-control" id="positionPercentage" value="1">
      </div>
   </div>
   <div id="positions" class="mt-3"></div>
   <div id="totalProfitSection">Загальний прибуток: <span id="totalProfit" class="positive">0</span></div>
   <button onclick="addPosition()" class="btn btn-primary mt-3">Додати позицію</button>

<div class="results-container mb-4">

        <div>
            <div class="p-2">
                <div class="h4 mb-0"><span id="total-pin">0</span></div>
            </div>
        </div>
    </div>
</div>
<script>
   let positionsCount = 0, totalProfit = 0, positionsData = {}, positionsClickable = {};

   function addPosition() {
     const deposit = +document.getElementById('deposit').value;
     const lossAmount = deposit * +document.getElementById('positionPercentage').value / 100;
     const positionCard = document.createElement('div');
     positionCard.className = 'card mb-2';
     positionCard.id = `position_${positionsCount}`;
     positionCard.innerHTML = `
       <div class="card-body">
         <h6 class="card-title">Позиція ${positionsCount + 1}: <span id="profit_${positionsCount}" class="positive">0</span></h6>
         <button onclick="updateProfit(${positionsCount}, -${lossAmount})" class="btn btn-danger" id="loss_${positionsCount}">Stop loss</button>
         <button onclick="setProfit(${positionsCount})" class="btn btn-success" id="profit_${positionsCount}">Take profit</button>
         <button onclick="removePosition(${positionsCount})" class="btn btn-warning">Видалити</button>
       </div>
     `;
     document.getElementById('positions').appendChild(positionCard);
     positionsData[positionsCount] = 0;
     positionsClickable[positionsCount] = true;
     positionsCount++;
   }

   function updateProfit(positionIndex, profit) {
     const deposit = document.getElementById('deposit').value;
     const lossButton = document.getElementById(`loss_${positionIndex}`);
     if (lossButton.disabled) return;
     const profitElement = document.getElementById(`profit_${positionIndex}`);
     const currentProfit = +profitElement.textContent;
     const newProfit = currentProfit + profit;
     const updatedProfit = `${addPlusSign((newProfit).toFixed(2))}$ (${addPlusSign(calc_percentage(newProfit, deposit))}%)`;
     profitElement.textContent = updatedProfit;


     // TOTAL PROFIT
     totalProfit += profit;
     const totalProfitElem = document.getElementById('totalProfit');
     totalProfitElem.textContent = createTotalProfitStr(totalProfit);
     document.getElementById(`total-pin`).textContent = createTotalProfitStr(totalProfit);
     totalProfitElem.classList.remove('positive', 'negative');

     if (totalProfit < 0) totalProfitElem.classList.add('negative');
     else if (totalProfit > 0) totalProfitElem.classList.add('positive');
     profitElement.classList.remove('positive', 'negative');
     if (updatedProfit < 0) profitElement.classList.add('negative');
     else if (updatedProfit > 0) profitElement.classList.add('positive');
     positionsData[positionIndex] = updatedProfit;
     lossButton.disabled = true;
     profitElement.disabled = true;
     positionsClickable[positionIndex] = false;
   }

   function createTotalProfitStr(totalProfit) {
      const deposit = document.getElementById('deposit').value;
      return `${addPlusSign(totalProfit.toFixed(2))}$ (${addPlusSign(calc_percentage(totalProfit, deposit).toFixed(2))}%)`;
   }

   function calc_percentage(val1, val2) {
      return (val1 * 100) / val2
   }

   function addPlusSign(number) {
    if (number > 0) {
        return "+" + number;
    }
    return number.toString();
}

   function setProfit(positionIndex) {
     if (!positionsClickable[positionIndex]) return;
     const riskReward = parseFloat(prompt('Enter Risk-Reward Ratio:'));
     if (isNaN(riskReward) || riskReward <= 0) {
       alert('Invalid Risk-Reward Ratio. Please enter a positive number.');
       return;
     }
     const deposit = +document.getElementById('deposit').value;
     const rewardAmount = deposit * (+document.getElementById('positionPercentage').value) * riskReward / 100;
     const currentProfit = positionsData[positionIndex];
     const profitDifference = rewardAmount - currentProfit;
     updateProfit(positionIndex, profitDifference);
   }

   function removePosition(positionIndex) {
     const positionCard = document.getElementById(`position_${positionIndex}`);
     let profit = positionsData[positionIndex];
     profit = parseFloat(profit.replace(/[^0-9.-]+/g,""));

     positionCard.remove();
     totalProfit -= profit;

     console.log(profit, totalProfit);

     let totalProfitElem = document.getElementById('totalProfit');
     totalProfitElem.textContent = createTotalProfitStr(totalProfit);


     totalProfitElem.classList.remove('positive', 'negative');

     if (totalProfit < 0) totalProfitElem.classList.add('negative');
     else if (totalProfit > 0) totalProfitElem.classList.add('positive');

     delete positionsData[positionIndex];
     delete positionsClickable[positionIndex];
   }

</script>
<style>
   #totalProfitSection {
    font-size: 20px;
    font-weight: bold;
   }
   #totalProfit {
     display: inline-block;
   }
   #totalProfit.negative {
     color: darkred;
   }
   #totalProfit.positive {
     color: darkgreen;
   }
   .card-title .negative {
     color: darkred;
   }
   .card-title .positive {

     color: darkgreen;
   }
</style>
{% endblock %}