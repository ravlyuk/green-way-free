{% extends 'base.html' %}

{% block title %}Trade helper{% endblock %}
{% block title_page %}Trade helper{% endblock %}

{% block content %}

<div class="container">
    <div class="form-row">
        <div class="form-group col-md-4">
            <label for="deposit">Депозит ($):</label>
            <input type="number" class="form-control" id="deposit" value="1000">
        </div>
        <div class="form-group col-md-4">
            <label for="positionPercentage">Відсоток позиції (%):</label>
            <input type="number" class="form-control" id="positionPercentage" value="1">
        </div>
    </div>
    <div id="positions" class="mt-3"></div>
    <div id="totalProfitSection">Загальний прибуток: <span id="totalProfit" class="positive">0</span> USD</div>
    <button onclick="addPosition()" class="btn btn-primary mt-3">Додати позицію</button>
</div>
<script>
    let positionsCount = 0;
    let totalProfit = 0;
    const positionsData = {};
    const positionsClickable = {};

    function addPosition() {

      const deposit = parseFloat(document.getElementById('deposit').value);
      const lossAmount = ((deposit / 100) * parseFloat(document.getElementById('positionPercentage').value)); // 1% of the deposit

      const positionCard = document.createElement('div');
      positionCard.className = 'card mb-2';
      positionCard.id = `position_${positionsCount}`;
      positionCard.innerHTML = `
        <div class="card-body">
          <h6 class="card-title">Позиція ${positionsCount + 1}: <span id="profit_${positionsCount}" class="positive">0</span> USD</h6>
          <button onclick="updateProfit(${positionsCount}, -${lossAmount})" class="btn btn-danger" id="loss_${positionsCount}">Stop loss</button>
          <button onclick="setProfit(${positionsCount})" class="btn btn-success" id="profit_${positionsCount}">Take profit</button>
          <button onclick="removePosition(${positionsCount})" class="btn btn-warning">Видалити</button>
        </div>
      `;

      document.getElementById('positions').appendChild(positionCard);
      positionsData[positionsCount] = 0;
      positionsClickable[positionsCount] = true; // Initialize the "Profit" button clickable state for this position card
      positionsCount++;
    }

    function updateProfit(positionIndex, profit) {
      const lossButton = document.getElementById(`loss_${positionIndex}`);
      if (lossButton.disabled) {
        return; // If Loss button is clicked again, don't change the value
      }

      const profitElement = document.getElementById(`profit_${positionIndex}`);
      const currentProfit = parseFloat(profitElement.textContent);
      const updatedProfit = currentProfit + profit;
      profitElement.textContent = updatedProfit.toFixed(2);

      totalProfit += profit;
      document.getElementById('totalProfit').textContent = totalProfit.toFixed(2);
      document.getElementById('totalProfit').classList.remove('positive', 'negative');

      if (totalProfit < 0) {
        document.getElementById('totalProfit').classList.add('negative');
      } else if (totalProfit > 0) {
        document.getElementById('totalProfit').classList.add('positive');
      }

      if (updatedProfit < 0) {
        profitElement.classList.remove('positive');
        profitElement.classList.add('negative');
      } else if (updatedProfit > 0) {
        profitElement.classList.remove('negative');
        profitElement.classList.add('positive');
      }

      positionsData[positionIndex] = updatedProfit;
      lossButton.disabled = true;
      profitElement.disabled = true;
      positionsClickable[positionIndex] = false; // Disable the "Profit" button for this position card
    }

    function setProfit(positionIndex) {
      if (!positionsClickable[positionIndex]) {
        return; // Prevent setting profit if the "Profit" button has already been clicked for this position card
      }

      const riskReward = parseFloat(prompt('Enter Risk-Reward Ratio:'));

      if (isNaN(riskReward) || riskReward <= 0) {
        alert('Invalid Risk-Reward Ratio. Please enter a positive number.');
        return;
      }

      const deposit = parseFloat(document.getElementById('deposit').value);
      const rewardAmount = ((deposit / 100) * parseFloat(document.getElementById('positionPercentage').value)) * riskReward;

      const currentProfit = positionsData[positionIndex];
      const profitDifference = rewardAmount - currentProfit;
      updateProfit(positionIndex, profitDifference);
    }

    function removePosition(positionIndex) {

      console.log(positionIndex);
      console.log(`position_${positionIndex}`);
      const positionCard = document.getElementById(`position_${positionIndex}`);
      const profit = positionsData[positionIndex];
      positionCard.remove();

      totalProfit -= profit;
      document.getElementById('totalProfit').textContent = totalProfit.toFixed(2);
      document.getElementById('totalProfit').classList.remove('positive', 'negative');

      if (totalProfit < 0) {
        document.getElementById('totalProfit').classList.add('negative');
      } else if (totalProfit > 0) {
        document.getElementById('totalProfit').classList.add('positive');
      }

      delete positionsData[positionIndex];
      delete positionsClickable[positionIndex];
    }


</script>

<style>
    #totalProfitSection {
      font-size: 20px;
      font-weight: bold;
      margin-top: 20px;
    }

    #totalProfit {
      display: inline-block;
    }

    #totalProfit.negative {
      color: darkred;
    }

    #totalProfit.positive {
      color: darkgreen;
    }

    .card-title .negative {
      color: darkred;
    }

    .card-title .positive {
      color: darkgreen;
    }



</style>
{% endblock %}
